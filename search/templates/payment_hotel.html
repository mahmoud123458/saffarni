{% load static %}
{% block add %}
<link rel="stylesheet" href="{% static 'CSS/payment.css' %}">
{% endblock add %}
<div class="container">
    <div class="card-container">
        <div class="front">
            <div class="image">
                <img src="{% static 'images/chip.png' %}" alt="Chip">
                <img src="{% static 'images/visa.png' %}" alt="Visa">
            </div>
            <div class="card-number-box">#### #### #### ####</div>
            <div class="flexbox">
                <div class="box">
                    <span>Card Holder</span>
                    <div class="card-holder-name">Full Name</div>
                </div>
                <div class="box">
                    <span>Expires</span>
                    <div class="expiration">
                        <span class="exp-month">MM /</span>
                        <span class="exp-year">YY</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="back">
            <div class="stripe"></div>
            <div class="box">
                <span>CVV</span>
                <div class="cvv-box"></div>
                <img src="{% static 'images/visa.png' %}" alt="Visa">
            </div>
        </div>
    </div>

    <form method="POST" action="{% url 'success' %}">
    {% csrf_token %}
        <div class="prices">
            <div>
                <span>Total Price</span>
            </div>
            <div>
                <h3>{{ hotel.price }}</h3>
            </div>
        </div>

        <div class="inputBox">
            <span>Crete ID</span>
            <input type="text" placeholder="Crete - ID: {{ hotel.id }}" readonly>
        </div>

        <div class="inputBox">
            <span>Your Name</span>
            <input type="text" placeholder="Enter Your Name Here" required>
        </div>

        <div class="inputBox">
            <span>Your Email</span>
            <input type="email" placeholder="Enter Your Email Here" required>
        </div>

        <div class="inputBox">
            <span>Card Number</span>
            <input type="text" maxlength="16" class="card-number-input" required>
        </div>

        <div class="inputBox">
            <span>Card Holder</span>
            <input type="text" maxlength="15" class="card-holder-input" required>
        </div>
        <div class="flexbox">
            <div class="inputBox">
                <span>Expiration MM</span>
                <select name="exp-month" class="month-input" required>
                    <option value="" selected disabled>Month</option>
                    <option value="01">01</option>
                    <option value="02">02</option>
                    <option value="03">03</option>
                    <option value="04">04</option>
                    <option value="05">05</option>
                    <option value="06">06</option>
                    <option value="07">07</option>
                    <option value="08">08</option>
                    <option value="09">09</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                </select>
            </div>
            <div class="inputBox">
                <span>Expiration YY</span>
                <select name="exp-year" class="year-input" required>
                    <option value="" selected disabled>Year</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                    <option value="2028">2028</option>
                    <option value="2029">2029</option>
                    <option value="2030">2030</option>
                </select>
            </div>
            <div class="inputBox">
                <span>CVV</span>
                <input type="text" maxlength="4" class="cvv-input" required>
            </div>
        </div>
        <input type="submit" value="Payment" class="submit-btn">
    </form>
</div>

<script>
    document.querySelector('.card-number-input').oninput = () => {
        document.querySelector('.card-number-box').innerText = document.querySelector('.card-number-input').value;
    }
    document.querySelector('.card-holder-input').oninput = () => {
        document.querySelector('.card-holder-name').innerText = document.querySelector('.card-holder-input').value;
    }
    document.querySelector('.month-input').onchange = () => {
        document.querySelector('.exp-month').innerText = document.querySelector('.month-input').value;
    }
    document.querySelector('.year-input').onchange = () => {
        document.querySelector('.exp-year').innerText = document.querySelector('.year-input').value;
    }
    document.querySelector('.cvv-input').onmouseenter = () => {
        document.querySelector('.front').style.transform = 'perspective(1000px) rotateY(-180deg)';
        document.querySelector('.back').style.transform = 'perspective(1000px) rotateY(0deg)';
    }
    document.querySelector('.cvv-input').onmouseleave = () => {
        document.querySelector('.front').style.transform = 'perspective(1000px) rotateY(0deg)';
        document.querySelector('.back').style.transform = 'perspective(1000px) rotateY(180deg)';
    }
    document.querySelector('.cvv-input').oninput = () => {
        document.querySelector('.cvv-box').innerText = document.querySelector('.cvv-input').value;
    }



    const stripe = Stripe('YOUR_STRIPE_PUBLIC_KEY');
    const elements = stripe.elements();

    const card = elements.create('card');
    card.mount('#card-element');

    const form = document.getElementById('payment-form');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const { token, error } = await stripe.createToken(card);

        if (error) {
            // Display error message to the user
            console.error(error.message);
        } else {
            // Send token to your server to process the payment
            // For example, using fetch()
            fetch('/process-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ token: token.id }),
            })
            .then(response => response.json())
            .then(data => {
                // Handle the response from your server
                console.log(data);
                if (data.success) {
                    // Redirect to a success page or show a success message
                    window.location.href = '/payment-success';
                } else {
                    // Display an error message to the user
                    console.error(data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    });

    function validateCardNumber(cardNumber) {
        // Visa card numbers start with 4 and have a length of 16 digits
        return /^4\d{15}$/.test(cardNumber);
    }
    
    function validateExpirationDate(expMonth, expYear) {
        // Validate the expiration date is in the future
        const currentYear = new Date().getFullYear() % 100; // Get last two digits of the current year
        if (expYear < currentYear || (expYear == currentYear && expMonth < new Date().getMonth() + 1)) {
            return false;
        }
        return true;
    }
    
    function validateCVV(cvv) {
        // CVV must be a 3 or 4-digit number
        return /^\d{3,4}$/.test(cvv);
    }
    
    document.getElementById('payment-form').addEventListener('submit', function(event) {
        const cardNumber = document.querySelector('.card-number-input').value;
        const expMonth = document.querySelector('.month-input').value;
        const expYear = document.querySelector('.year-input').value;
        const cvv = document.querySelector('.cvv-input').value;
    
        if (!validateCardNumber(cardNumber)) {
            alert('Please enter a valid Visa card number');
            event.preventDefault();
        } else if (!validateExpirationDate(expMonth, expYear)) {
            alert('Please enter a valid expiration date');
            event.preventDefault();
        } else if (!validateCVV(cvv)) {
            alert('Please enter a valid CVV');
            event.preventDefault();
        }
    });
    
</script>
